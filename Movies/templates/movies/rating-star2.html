{% extends 'base_layout.html' %}
{% block content %}

<style>
.checked {
    color: orange;
}
</style>

<p id="user-id">456<p>
<h2>Star Rating</h2>
<span class="fa fa-star" id="star1-25" onclick="add_star(this,1,25)"></span>
<span class="fa fa-star" id="star2-25" onclick="add_star(this,2,25)"></span>
<span class="fa fa-star" id="star3-25" onclick="add_star(this,3,25)"></span>
<span class="fa fa-star" id="star4-25" onclick="add_star(this,4,25)"></span>
<span class="fa fa-star" id="star5-25" onclick="add_star(this,5,25)"></span>
<span class="fa fa-star" id="star6-25" onclick="add_star(this,6,25)"></span>
<span class="fa fa-close" id="notseen-25" style="float: right" onclick="add_notseen(this,25)"></span>
<br>
<form action="." method="post">
  {% csrf_token %}
  <button name="button-name" value="fav_HTML" class="btn btn-primary btn-lg active pull-right" role="button" onclick="save_ratings()">Next page</button>
</form>
<script>
  // https://bootsnipp.com/snippets/dlaaN
  function add_star(ths,sno,movie_id){
    for (var i=1;i<=6;i++){
      var cur=document.getElementById("star"+i+"-"+movie_id)
      cur.className="fa fa-star"
    }
    for (var i=1;i<=sno;i++){
      var cur=document.getElementById("star"+i+"-"+movie_id)
      if(cur.className=="fa fa-star")
      {
        // mark stars as checked and notseen as not checked
        cur.className="fa fa-star checked"
        document.getElementById("notseen-"+movie_id).className="fa fa-close"
      }
    }
  }
  function add_notseen(ths,movie_id){
    var cur=document.getElementById("notseen-"+movie_id)
    if(cur.className=="fa fa-close")
    {
      // mark stars as not checked and notseen as checked
      cur.className="fa fa-close checked"
      document.getElementById("star"+1+"-"+movie_id).className="fa fa-star"
      document.getElementById("star"+2+"-"+movie_id).className="fa fa-star"
      document.getElementById("star"+3+"-"+movie_id).className="fa fa-star"
      document.getElementById("star"+4+"-"+movie_id).className="fa fa-star"
      document.getElementById("star"+5+"-"+movie_id).className="fa fa-star"
      document.getElementById("star"+6+"-"+movie_id).className="fa fa-star"
    }
  }
// parses current document and gets an array of
// currently rendered movies ids
// (returns array of integers)
function get_movie_ids(ths) {
  var movie_notseen_elements = $('*[id^="notseen-"]');
  var movie_ids = new Array();
  for (var i=0; i<movie_notseen_elements.length; i++) {
    // e.g. notseen-25
    var css_identifier = movie_notseen_elements[i].id
    var movie_id = css_identifier.split('-')[1]
    movie_ids.push(movie_id)
  }
  return movie_ids
}
// parses current document and gets an array of
// dictionaries of movie_id + rating
function get_movies_ratings(ths, movie_ids) {
  var ratings = new Array();
  for (var i=0; i<movie_ids.length; i++) {
    // for each movie
    movie_id = movie_ids[i]
    rating = 0
    if (document.getElementById("notseen-"+movie_id).className.includes("checked")) {
      rating = -1
    } else if (document.getElementById("star"+6+"-"+movie_id).className.includes("checked")) {
      rating = 6
    } else if (document.getElementById("star"+5+"-"+movie_id).className.includes("checked")) {
      rating = 5
    } else if (document.getElementById("star"+4+"-"+movie_id).className.includes("checked")) {
      rating = 4
    } else if (document.getElementById("star"+3+"-"+movie_id).className.includes("checked")) {
      rating = 3
    } else if (document.getElementById("star"+2+"-"+movie_id).className.includes("checked")) {
      rating = 2
    } else if (document.getElementById("star"+1+"-"+movie_id).className.includes("checked")) {
      rating = 1
    }
    ratings.push({
      movie_id: movie_id,
      movie_rating: rating
    })
    alert('movie id: ' + movie_ids[i] + ' rating: '+ rating + ' user id: ' + user_id);
    return ratings
  }
}
function save_ratings(ths){
  // innerHTML this gets the content of the <p>
  user_id = document.getElementById("user-id").innerHTML
  movie_ids = get_movie_ids()
  ratings = get_movies_ratings(ths, movie_ids)
  my_post_data = {
    user_id: user_id,
    ratings: ratings
  }
  my_post_data_str = JSON.stringify(my_post_data)
  $.ajax({
    type: "POST",
    url: "/movies/insert_rating/",
    data: my_post_data_str,
    // make it visible on your web browser developer tools
    success: console.log(my_post_data_str),
    dataType: 'JSON'
  });
}
</script>
{% endblock %}
